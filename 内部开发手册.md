# git

- git教程请参考[Git教程 - 廖雪峰的官方网站 (liaoxuefeng.com)](https://www.liaoxuefeng.com/wiki/896043488029600)
- dataset/example目录存放一些toy dataset，作为示例demo，可以上传readme对数据集格式示例进行解释说明，**严禁上传大型数据，尤其是二进制文件（图片等）**
- 技巧：多开分支，多commit
  - 每次完成一个小功能后就可以commit，万一出问题还能回退，不要等到所有东西做完了才一次性commit
  - commit信息用英文粗略说明，但不要过于含糊（如，只写一个update）
  - 开发新模型/新功能
    - 错误做法：直接将新代码上传到`master`或者使用`master`进行开发
    - 正确做法：
      1. 在本地从`master`分支重新开一个新分支（如：`feature1`）用于开发
      2. 开发完成后再将该分支`feature1`推送到远程的`feature1`
      3. **在远程**将`feature1`合并到`master`
- 分支中不要动的文件（以免跟master产生冲突，如果要修改，请在**master**上直接修改，并提前招呼）：

  - readme：新增模型后不需要在readme的表格中说明

  - 所有模块中的init.py文件
- 项目中所有目录下，名字中含有test的文件和文件夹，以及生成的日志log文件等，都会被git忽略，可以在里面随便写自己的测试代码，不用担心冲突修改等问题



# code

## 项目结构

- config：暂时闲置
- data：数据模块
  - dataset：存放数据集类，若内置的TextDataset和MultiModalDataset无法满足需要，可以自己新开一个文件写XXDataset类
  - process：存放所有跟数据处理相关的函数/类，注意与**utils**模块区分
- evaluate：评估模块
  - evaluator：评估器类
  - metrics：指标计算函数，用于生成评估器
- model：模型模块
- properties：run模块所需的yaml配置文件示例，用于说明每个`run_from_yaml`的文件示例
- run：每个模型运行的函数
- trainer：
  - BaseTrainer：适用于字典格式的数据
  - GNNTrainer：适用于pyg中`Data`格式的数据
- utils：与数据处理无关的工具函数/类



## 编码要求

- 移植模型到FaKnow中时，不要动模型的表现效果，但可以通过简化代码、向量化等操作提升计算速度

- 所有模型的实现细节，以及lr、batch size等超参数务必与原作者代码**保持一致**，以便能复现出正确结果

- 保持一致**不代表把源代码原封不动抄进来**，请注意**算法与工程的区别**

  - 原版代码是算法demo，是作者为了快速实验来验证自己的想法的产物，可能存在下面各种问题，需要我们润色整理
    - 写得非常凌乱，并不符合软件工程规范，如变量命名、随意开全局变量等，可以修改整理
    - 存在一直没使用过/没执行的代码块，可以去掉
    - 有冗余的代码操作（如数据加载时的部分代码等），可以简化
  - 我们做的是统一的算法库，是会在GitHub和PyPi上开源给其他人使用的产品，所有东西是按一个完整系统的标准做，有属于自己的一套统一规范的行为逻辑和API（想想平时用过的sklearn、transformers等算法库），如果只是把原作者代码一股脑塞进来，随着库里的模型越来越多，整个库将会变成代码“屎山”
  - 遇事不决，请多参考库中已有的算法示例，如EANN（有MultiModalDataset、模型多个输出、多个loss累加的编写示例）、MDFEND（有TextDataset、Bert的使用示例）等

- 尽量**复用库中已有的功能/模块**，减少重复性的代码

- 关于数据

  - 对于数据文件，除非迫不得已，否则**慎用二进制文件**形式，因为用户往往不清楚二进制文件内部格式
  - 数据文件路径请勿在代码中写死，因为用户电脑上的路径往往跟你的不一样，请通过参数留给用户配置的空间

- 关于tensor

  - 尽量不要np与tensor混用，能用tensor就用tensor
  - 尽量使用向量化操作而非for循环，以便于充分使用cuda加速
  - 训练时使用的device请通过参数配置，并使用`to(device)`移动tensor，而非采用类似`text.cuda()`这种硬编码方式

- 请保持良好的代码规范和习惯，包括但不限于

  - 命名：变量、函数使用**蛇形**（如：`text_features`）；类使用**大驼峰**（如：`NewModel`）；不要使用变量`a`这种命名方式

  - 只在一个文件中使用的函数/类请在最前加下划线`_`私有化，避免被其他的包误导入（关于python各种下划线写法，请参考[Python 各种下划线](https://zhuanlan.zhihu.com/p/105783765)）

  - **请勿直接在函数/类的外部定义全局变量**，使用**OOP**而非面向过程的编码习惯

  - 代码格式化：保证pep8格式（运算符左右两侧空格等），不会的话，在每次commit前，使用vscode/pycharm中的格式化代码功能

  - 注释：函数、类请**严格使用google风格**注释，并在括号中**声明参数类型+函数返回类型**，**tensor请说明输入输出的shape**，以便于将来能顺利被程序识别并自动生成对应的API文档（pycharm中可以自动生成注释并设置注释格式）

  - 错误示例

    ```python
    c=1
    def f(a, b):
        return a+b
    ```

  - 正确示例

    ```python
    def sum(num1: int, num2: int, num3=1) -> int:
        """
        calculate sum of 2 integers
        
        Args:
        	num1 (int): the first number
        	num2 (int): the second number
        	num3 (int): the third number, default=1
    
        Returns:
        	int: sum
        """
    
        return a + b + c
    ```

- 开发新模型要上传的代码文件包括

  - dataset：如果自己没有新增数据集类而是使用库中已有的，可以不用这项
  - model：新增的模型
  - run：运行模型的函数
  - 其他：根据自己需要，可以在utils或者process中新增函数等，但是请务必提前打招呼，以免跟master产生冲突